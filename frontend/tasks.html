<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tasks - Wellbeing Companion</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="navbar.css">
  <style>
    body {
      padding: 0;
      margin: 0;
    }

    .page-content {
      padding-top: 100px;
      padding-left: 20px;
      padding-right: 20px;
      padding-bottom: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .page-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      border: 1px solid rgba(70, 196, 126, 0.1);
      box-shadow: var(--shadow-lg);
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
    }

    .page-header h1 {
      font-size: 32px;
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .page-header p {
      color: var(--text-medium);
      font-size: 16px;
    }

    .stats-bar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(70, 196, 126, 0.1);
      box-shadow: var(--shadow-md);
      padding: 25px;
      margin-bottom: 25px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 25px;
    }

    .stat-item {
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, rgba(70, 196, 126, 0.05) 0%, rgba(58, 166, 105, 0.05) 100%);
      border-radius: 16px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary-green);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-medium);
      font-weight: 600;
    }

    .filter-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(70, 196, 126, 0.1);
      padding: 20px;
      margin-bottom: 25px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-label {
      font-weight: 700;
      color: var(--text-dark);
      font-size: 15px;
    }

    .filter-btn {
      padding: 10px 20px;
      background: transparent;
      border: 2px solid rgba(70, 196, 126, 0.2);
      border-radius: 10px;
      color: var(--text-medium);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-dark) 100%);
      border-color: var(--primary-green);
      color: white;
      box-shadow: 0 4px 12px rgba(70, 196, 126, 0.3);
    }

    .filter-btn:hover:not(.active) {
      border-color: var(--primary-green);
      transform: translateY(-2px);
    }

    .tasks-grid {
      display: grid;
      gap: 20px;
    }

    .task-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 2px solid rgba(70, 196, 126, 0.2);
      box-shadow: var(--shadow-md);
      padding: 25px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .task-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-green);
    }

    .task-card.completed {
      opacity: 0.8;
      border-color: rgba(70, 196, 126, 0.5);
      background: rgba(70, 196, 126, 0.03);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .task-type {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(70, 196, 126, 0.15) 0%, rgba(58, 166, 105, 0.15) 100%);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: var(--primary-green);
    }

    .task-type.video {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
      color: #dc2626;
    }

    .task-type.article {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.15) 100%);
      color: #2563eb;
    }

    .task-duration {
      font-size: 13px;
      color: var(--text-medium);
      font-weight: 600;
      padding: 6px 12px;
      background: rgba(107, 114, 128, 0.1);
      border-radius: 8px;
    }

    .task-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .task-description {
      color: var(--text-medium);
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .task-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn-task {
      flex: 1;
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-start {
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(70, 196, 126, 0.3);
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(70, 196, 126, 0.4);
    }

    .btn-completed {
      background: rgba(70, 196, 126, 0.1);
      color: var(--primary-green);
      border: 2px solid var(--primary-green);
      cursor: default;
    }

    .completion-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 16px rgba(70, 196, 126, 0.4);
    }

    .empty-state {
      text-align: center;
      padding: 80px 30px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      border: 2px dashed rgba(70, 196, 126, 0.3);
    }

    .empty-state-icon {
      font-size: 80px;
      margin-bottom: 25px;
    }

    .empty-state h3 {
      font-size: 28px;
      color: var(--text-dark);
      margin-bottom: 12px;
    }

    .empty-state p {
      color: var(--text-medium);
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .page-content {
        padding-top: 80px;
      }

      .stats-bar {
        grid-template-columns: 1fr;
      }

      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body data-page="tasks">

  <div class="page-content">
    <div class="container">
      <div class="page-header fade-in">
        <h1>üìö Your Wellbeing Tasks</h1>
        <p>Personalized resources to support your mental health journey</p>
      </div>

      <div class="stats-bar fade-in" style="animation-delay: 0.1s;">
        <div class="stat-item">
          <div class="stat-value" id="total-tasks">0</div>
          <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completed-tasks">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completion-rate">0%</div>
          <div class="stat-label">Completion Rate</div>
        </div>
      </div>

      <div class="filter-section fade-in" style="animation-delay: 0.2s;">
        <span class="filter-label">Filter:</span>
        <button class="filter-btn active" onclick="filterTasks('all')">All Tasks</button>
        <button class="filter-btn" onclick="filterTasks('video')">üìπ Videos</button>
        <button class="filter-btn" onclick="filterTasks('article')">üìÑ Articles</button>
        <button class="filter-btn" onclick="filterTasks('pending')">‚è≥ Pending</button>
        <button class="filter-btn" onclick="filterTasks('completed')">‚úÖ Completed</button>
      </div>

      <div id="tasks-container">

        <div class="empty-state">
          <div class="empty-state-icon">üìù</div>
          <h3>Loading your tasks...</h3>
          <p>Please wait while we fetch your personalized resources</p>
        </div>
      </div>
    </div>
  </div>

  <script src="navbar.js"></script>
  <script>
    let allTasks = [];
    let currentFilter = 'all';

    // Load tasks from localStorage
    function loadTasks() {
      try {
        allTasks = JSON.parse(localStorage.getItem('userTasks') || '[]');
        console.log('‚úÖ Loaded tasks from localStorage:', allTasks.length);
        
        if (allTasks.length === 0) {
          showEmptyState('no-tasks');
        } else {
          renderTasks();
          updateStats();
        }
        
      } catch (error) {
        console.error('‚ùå Failed to load tasks:', error);
        showEmptyState('error');
      }
    }

    function renderTasks() {
      const container = document.getElementById('tasks-container');
      
      let filteredTasks = allTasks;
      if (currentFilter === 'video') {
        filteredTasks = allTasks.filter(t => t.type === 'video');
      } else if (currentFilter === 'article') {
        filteredTasks = allTasks.filter(t => t.type === 'article');
      } else if (currentFilter === 'pending') {
        filteredTasks = allTasks.filter(t => !t.completed);
      } else if (currentFilter === 'completed') {
        filteredTasks = allTasks.filter(t => t.completed);
      }
      
      if (filteredTasks.length === 0) {
        showEmptyState('no-filtered');
        return;
      }
      
      container.innerHTML = `
        <div class="tasks-grid">
          ${filteredTasks.map((task, index) => `
            <div class="task-card fade-in ${task.completed ? 'completed' : ''}" 
                 style="animation-delay: ${index * 0.05}s;"
                 data-task-id="${task.id}">
              ${task.completed ? '<div class="completion-badge">‚úì Completed</div>' : ''}
              
              <div class="task-header">
                <span class="task-type ${task.type}">
                  ${task.type === 'video' ? 'üìπ' : 'üìÑ'} ${task.type}
                </span>
                <span class="task-duration">${task.duration}</span>
              </div>
              
              <h3 class="task-title">${task.title}</h3>
              <p class="task-description">${task.description}</p>
              
              <div class="task-actions">
                ${task.completed ? 
                  `<button class="btn-task btn-completed">
                    ‚úì Completed ${task.completedAt ? new Date(task.completedAt).toLocaleDateString() : ''}
                   </button>` :
                  `<button class="btn-task btn-start" onclick="startTask('${task.id}', '${task.url}')">
                    ${task.type === 'video' ? '‚ñ∂Ô∏è Watch Now' : 'üìñ Read Now'}
                  </button>`
                }
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    async function startTask(taskId, url) {
      // Open the resource
      window.open(url, '_blank');
      
      // Mark as completed
      try {
        const response = await fetch(`http://localhost:3001/tasks/main/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ taskId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          console.log('‚úÖ Task completed:', taskId);
          
          // Update local state
          const task = allTasks.find(t => t.id === taskId);
          if (task) {
            task.completed = true;
            task.completedAt = new Date().toISOString();
          }
          
          // Re-render
          renderTasks();
          updateStats();
          
          // Show success message
          showNotification('üéâ Great job! Task completed and synced to dashboard.');
        }
      } catch (error) {
        console.error('‚ùå Failed to mark task as completed:', error);
        showNotification('‚ùå Failed to sync. Please check your connection.');
      }
    }

    function saveCompletedTask(task) {
      try {
        let dashboardData = JSON.parse(localStorage.getItem('dashboardData') || '{"insights": []}');
        
        if (!dashboardData.insights) {
          dashboardData.insights = [];
        }
        
        dashboardData.insights.push({
          icon: task.type === 'video' ? 'üìπ' : 'üìÑ',
          text: `Completed: ${task.title}`,
          timestamp: new Date().toISOString(),
          taskId: task.id
        });
        
        localStorage.setItem('dashboardData', JSON.stringify(dashboardData));
        console.log('üíæ Saved completed task to dashboard');
      } catch (error) {
        console.error('Failed to save to dashboard:', error);
      }
    }

    function updateStats() {
      const total = allTasks.length;
      const completed = allTasks.filter(t => t.completed).length;
      const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
      
      document.getElementById('total-tasks').textContent = total;
      document.getElementById('completed-tasks').textContent = completed;
      document.getElementById('completion-rate').textContent = `${rate}%`;
    }

    function filterTasks(filter) {
      currentFilter = filter;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderTasks();
    }

    function showEmptyState(type) {
      const container = document.getElementById('tasks-container');
      
      if (type === 'no-tasks') {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <h3>No tasks yet</h3>
            <p>Start chatting with your AI companion to receive personalized wellbeing resources!</p>
            <button class="btn-primary" onclick="window.location.href='index.html'" 
                    style="padding: 15px 30px; font-size: 16px; margin-top: 10px;">
              Start Chat
            </button>
          </div>
        `;
      } else if (type === 'no-filtered') {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>No tasks match this filter</h3>
            <p>Try selecting a different filter option</p>
          </div>
        `;
      } else if (type === 'error') {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <h3>Failed to load tasks</h3>
            <p>There was an error loading your tasks</p>
            <button class="btn-primary" onclick="loadTasks()" 
                    style="padding: 15px 30px; font-size: 16px; margin-top: 10px;">
              Retry
            </button>
          </div>
        `;
      }
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 18px 26px;
        border-radius: 14px;
        box-shadow: 0 8px 28px rgba(70, 196, 126, 0.4);
        z-index: 1000;
        animation: slideIn 0.4s ease;
        font-weight: 600;
        font-size: 15px;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.4s ease';
        setTimeout(() => notification.remove(), 400);
      }, 3000);
    }

    loadTasks();
  </script>

</body>
</html>